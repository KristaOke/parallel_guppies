---
title: "Slopes & Drainages"
output: html_notebook
---


```{r read in}
library(tidyverse)
library(ggplot2)
#setwd("<YOURPATHWAY>")
wd <- getwd()
new.data<- read.csv(paste(wd,'/Data/MetaData.csv',sep=""), header=TRUE, sep=",") #MetaData saved oct 27th
data<- read.csv(paste(wd,'/Data/Data.csv',sep=""), header=TRUE, sep=",")%>% #Data.csv is saved straight from .xlsx feb 10th
  select(StudyID:Comments) 
r.squared<- read.csv(paste(wd,'/Data/TraitR2.csv',sep=""), header=TRUE, sep=",") #R2 generated oct 1st (& _sexID)
```


North: 
Yarra, Marianne, Paria, Madamas, Damier, Brasso Seco, Balandra *Tompire*, *Ricon*, *Mission*, *Toco* (*northeast?*)

South: 
Caroni Drainage (Tunapuna, Lopinot, Guanapo, Aripo, Cuara, Tranquille, Caroni, Arima, Arouca, Mausica, Tacarigua, El Cedro, Ceniza, Naranjo, Maracas, Caroni Lower Dyke, Cuara, Manacal)
Oropuche Drainage (Quare, Oropuche, Turure, La Seiva, Rio Barro, Rio Grande, La Selva, Visigney, Valencia, Matura)

*Questionable/Notes*
Madamas: Potentially a northern drainage, it's right beside the Paria to the east
Naranjo: upper aripo
Tumbason:south, drainage? not included anymore
Hollis: South? not included anymore
Tompire: west coast usually counted as northern range but not connected to others 
Mission: North but over near Tompire
Ricon: north but east and not connected to a drainage
Toco: north east like tompire
Cunupia Lower Dyke: near caroni but listed as distinct in 23, has gps in supplementary mat.	
Manzanilla:	No gps, listed as separate drainage
Matura: inlcuded for now in oropuche but some say it's not because its far east and north a bit
Cenzina changed to Ceniza (typo confirmed in paper)

*Southern trinidad outside northern mountain range*

Southern trinidad outside northern mountain range
Pilote and lower trib 1 &2 are a part of a Mayaro drainage, in southern trinidad)
Lizard
Guapo
Coffee
Silverstream
Arena: Near the arena reservoir some place? thoroughly out of the mountains
Vance: South West (from jackie outside the northern range, also in paper 23, but not listed in supplementary material as a site??)


```{r population column}
data$temp<-NA #temp columns
data$pop<-data$PopulationRaw

names<-c("Arima","Arena","Arouca","Aripo", "Quare", "Yarra", "Tompire", "Marianne", "Paria", "El Cedro", "Madamas",
         "Oropuche", "Guanapo", "La Selva", "Turure", "Damier", "Tacarigua", "Mausica", "Manacal", "Ceniza", "Caroni",
         "Valencia", "Oropuna", "Tunapuna", "Lopinot", "Guapo", "Vance", "Visigney", "Pilote", "Lizard",
         "Silverstream", "Matura","Cunupia", "Coffee", "Maracas", "Caura", "Toco", "Manzanilla", "Mission", "Ricon",
         "Balandra", "Brasso Seco", "Rio Grande", "Rio Barro", "Caroni Lower Dyke", "Cunupia Lower Dyke")
for (i in names){ data<-mutate(data, pop = (ifelse(grepl(i, PopulationRaw), i,  temp)))
data$temp<-ifelse(data$pop==i, i, data$temp)} #replaces variations of populations with the root, ie Aripo 4 -> Aripo

data$pop<-ifelse(is.na(data$pop),data$PopulationRaw, data$pop) #fill NAs with the raw population data

#fix typos

data$pop<-gsub("ElCedro1", "El Cedro", data$pop)
data$pop<-gsub("ElCedro2", "El Cedro", data$pop)
data$pop<-gsub("Lower Guapo 1", "Guapo", data$pop)
data$pop<-gsub("Lower Guapo 2", "Guapo", data$pop)
data$pop<-gsub("Laseiva", "La Seiva", data$pop)
data$pop<-gsub("Cenzina", "Ceniza", data$pop)
data$pop<-gsub("Lower Trib 1", "Mayaro", data$pop)
data$pop<-gsub("Lower Trib 2", "Mayaro", data$pop)
data$pop<-gsub("Tompire 2", "Tompire", data$pop)
data$pop<-gsub("guanapo", "Guanapo", data$pop)
data$pop<-gsub("Lower La Seiva", "La Seiva", data$pop)
data$pop<-gsub("Upper turure", "Turure", data$pop)
data$pop<-gsub("Tacargua", "Tacarigua", data$pop)

#data$pop<-ifelse(grepl("Dyke", data$PopulationRaw), data$PopulationRaw, data$pop)

summary(as.factor(data$pop))
data$Population<-data$pop
data<-data %>% 
  select(StudyID:Comments)
```



```{r typos and river lists, eval=FALSE}
#fix typos not previously found
data$TraitType2<-gsub("Life-history", "Life history", data$TraitType2)

data$Population<-as.factor(data$Population)
river.list<-data %>% 
  select(Population) %>% 
  unique()

North<-c("Yarra", "Marianne", "Paria", "Madamas", "Damier", "Brasso Seco", "Balandra") #I think we should keep these together for drainage level, logistically it'll be easier and its how others do it (paper 2 is an example)

Northeastern<- c("Tompire", "Ricon", "Mission", "Toco")

Other<-c("Pilote", "Lizard", "Guapo", "Coffee", "Silverstream", "Arena", "Vance", "Mayaro", "Cunupia Lower Dyke", "Caura", "Manzanilla", "Oropuna", "Hollis") #mostly southern range, jessica stephenson paper, but some others

South<-c("Tunapuna", "Lopinot", "Guanapo", "Aripo", "Cuara", "Tranquille", "Caroni", "Arima", "Arouca", "Mausica", "Tacarigua", "El Cedro", "Ceniza", "Naranjo", "Maracas", "Caroni Lower Dyke", "Cuara", "Manacal", "Quare", "Oropuche", "Turure", "La Seiva", "Rio Barro", "Rio Grande", "La Selva", "Visigney", "Valencia", "Matura", "Hollis", "Saint Joseph")  

#Drainage level
Caroni<-c("Tunapuna", "Lopinot", "Guanapo", "Aripo", "Cuara", "Tranquille", "Caroni", "Arima", "Arouca", "Mausica", "Tacarigua", "El Cedro", "Ceniza", "Naranjo", "Maracas", "Caroni Lower Dyke", "Cuara", "Manacal", "Saint Joseph")

Oropuche<-c("Quare", "Oropuche", "Turure", "La Seiva", "Rio Barro", "Rio Grande", "La Selva", "Visigney", "Valencia", "Matura", "Hollis")

#rivers not already sorted into north or south slope
#unknown.rivers<-subset(river.list, (!(river.list$Population %in% North | river.list$Population %in% South| river.list$Population %in% Northeastern| river.list$Population %in% Other))) 
```



```{r Slope, Drainage, and TraitID columns, eval=FALSE}

#new.data<-data #!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! don't forget this you dummy

new.data$Slope<-  case_when(
  new.data$Population %in% South ~ "South",
  new.data$Population %in% North ~ "North",
  new.data$Population %in% Other ~ "Other",
  new.data$Population %in% Northeastern ~ "Northeastern"
) #labels all single populations as North or South Slope, and other for identified rivers not in this dichotomy

new.data$Drainage<- case_when(
  new.data$Population %in% Caroni ~ "Caroni",
  new.data$Population %in% Oropuche ~ "Oropuche",
  new.data$Population %in% North ~ "Northern",
  new.data$Population %in% Other ~ "Other",
  new.data$Population %in% Northeastern ~ "Other",
)  #Labels all single populations as a specific drainage

#coding the trait column, one ID for each trait measured in each study (regardless of sex)
#new.data<-new.data %>% 
  #arrange(StudyID, Trait)
#lengths<-rle(as.character(new.data$Trait))
#new.data$TraitID<-rep(seq_along(lengths$lengths), lengths$lengths)
new.data<-new.data %>% 
  arrange(StudyID, StudyType, Trait, Sex, Predation)

#coding the trait column, one ID for each trait measured in each sex group in each study, THIS WAY IS BETTER
sex.length<-rle(as.character(paste(new.data$Trait,new.data$Sex,new.data$StudyType)))  
new.data$TraitID<-rep(seq_along(sex.length$lengths), sex.length$lengths)

x<-as.data.frame(sex.length[["lengths"]])
y<-x %>% 
  subset(`sex.length[["lengths"]]`<3) #traits 3,6,59,84 have only 2 or 1 entry typos 28/29, 542 (not fixed yet)

new.data %>% 
  group_by(TraitID) %>% 
  filter(all(c("Common Garden (F1)", "Wildcaught") %in% StudyType )) #I think this checks out!!

test<-new.data[is.na(new.data$Slope),]
```


testing a slope column that indicates if within a trait populations are all from the southern slope (south), are all from northern slope (north), or are from both (mixed). Also need to know how many of each we have
```{r overall slope column}
slope.data<-new.data %>% 
  group_by(TraitID) %>% 
  mutate(unique_slopes = n_distinct(Slope))
slope.data$Slope.type<-ifelse(slope.data$unique_slopes==1, slope.data$Slope, "Mixed")

summary(as.factor(slope.data$unique_slopes))
summary(as.factor(slope.data$Slope.type))

x<-slope.data[!duplicated(slope.data$TraitID),]
summary(as.factor(x$unique_slopes))
summary(as.factor(x$Slope.type))

#write_csv(slope.data, path = "~/Documents/Masters/R scripts/Meta Analysis/Data/MetaData.csv") #written feb 11th
```

gonna create a loop to determine the ratio of north to south within each trait
```{r ratio of north and south}
slope.ratio<-slope.data %>% 
  group_by(TraitID) %>% 
  summarise(South = sum(Slope=="South"), North = sum(Slope=="North"), ratio = North/South)
slope.ratio<-slope.ratio %>% 
  subset(ratio > 0 & ratio < 1)
hist(slope.ratio$ratio)
```


```{r numbers for questions}
test<-new.data %>% 
  filter(!is.na(MeanValue)) %>% 
  filter(!is.na(Number)) %>% 
  filter(!is.na(SD) | !is.na(SE))

new.data[!duplicated(new.data$TraitID),] %>% 
  group_by(Slope.type) %>%
  summarize(count = n())

test<-new.data %>% 
  filter(Slope.type == "South") %>% 
  group_by(TraitID) %>% 
  mutate(unique_drainages = n_distinct(Drainage))

test$Drainage.type<-ifelse(test$unique_drainages==1, test$Drainage, "Mixed")

test[!duplicated(test$TraitID),] %>% 
  group_by(Drainage.type) %>%
  summarize(count = n())
```


### visualising year data and spread for collection years
```{r years, eval=FALSE}
year<-new.data %>% 
  mutate(duration =  (as.numeric(str_sub(CollectionYear, -4))) - (as.numeric(str_sub(CollectionYear, start = 0, 4)))) %>% 
  mutate(YearStart = as.numeric(str_sub(CollectionYear, start = 0, 4))) %>% 
  filter(duration < 2) #27 studies under 2 years, 4 studies with a higher range (Aug 6th)

#year$YearEnd<-as.numeric(str_sub(year$CollectionYear, -4)) #if we want the last year of collection


traitData<-left_join(r.squared, year, by = "TraitID")
traitData<-traitData[!duplicated(traitData$TraitID),]
```


```{r year plots, eval=FALSE}
ggplot(year, aes(YearStart))+geom_histogram(stat = "count")

ggplot(year, aes(as.Date(YearStart, format = "%Y"), as.Date(YearEnd, format = "%Y")))+geom_point()+ geom_abline(intercept = 0, slope = 1) +  scale_x_date(date_labels = "%Y")


ggplot(traitData, aes(as.Date(YearStart, format = "%Y"), R.2))+geom_point()

```


### plots?? R2
```{r R2 prep}
r.squared$TraitID<-as.numeric(r.squared$traitID)

slope.info<-new.data %>% 
  group_by(TraitID) %>%
  summarise(n_distinct(Slope))
summary(as.factor(slope.info$`n_distinct(Slope)`), maxsum = 100)

new.data<-left_join(new.data, r.squared, by = "TraitID")
new.data<-left_join(new.data, slope.info, by = "TraitID")
new.data$R.2<-as.numeric(new.data$R.2)
```



```{r plots violin}
ggplot(data = new.data, aes(x=TraitType2, y = R.2, fill = TraitType2)) + geom_violin() 
ggplot(data = new.data, aes(x=TraitType1, y = R.2, fill = TraitType1)) + geom_violin() 

new.data %>% 
  filter(`n_distinct(Slope)`==1) %>% 
ggplot(aes(x=Slope, y = R.2, fill = Slope)) + geom_violin() 

new.data %>% 
  filter(`n_distinct(Slope)`==1) %>% 
ggplot(aes(x=TraitType2, y = R.2, fill = Slope)) + geom_violin()

new.data %>% 
  filter(`n_distinct(Slope)`==1) %>% 
ggplot(aes(x=TraitType1, y = R.2, fill = Slope)) + geom_violin()

#ggplot(data = new.data, aes(x=StudyType, y = R.2, fill = StudyType)) + geom_violin() 

#sex specific plots
new.data %>% 
  filter(Sex == "M" | Sex == "F") %>% 
ggplot( aes(x = Sex, y = R.2, fill = Sex)) + geom_violin()

new.data %>% 
  filter(Sex == "M" | Sex == "F") %>% 
ggplot( aes(x = TraitType2, y = R.2, fill = Sex)) + geom_violin()

new.data %>% 
  filter(Sex == "M" | Sex == "F") %>% 
ggplot( aes(x = TraitType1, y = R.2, fill = Sex)) + geom_violin()

```


### Mapping miscellaneous ###

```{r mapping prep}
location.data<-new.data[!is.na(new.data$Location),]
coordinates<-location.data[!duplicated(location.data$Location),] %>% 
  select(1:3,13:22,32)

#write_csv(coordinates, path = "~/Documents/Masters/R scripts/Meta Analysis/Data/Coordinates.csv")
Coordinates <- read_excel("~/Documents/Masters/R scripts/Meta Analysis/Data/Coordinates.xlsx")
Coordinates<-Coordinates %>% 
  select(11:13) %>% 
  rename(Location = 3)
Coordinates<-separate(Coordinates, Location, into = c("Easting", "Northing"), sep = 6, remove = FALSE)
Coordinates$ID<-1:94
#write_csv(Coordinates, path = "~/Documents/Masters/R scripts/Meta Analysis/Data/Coordinates.csv")
```





